<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>学習用架空株式市場</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body {
        font-family: sans-serif;
        background: #121212;
        color: #eee;
        margin: 0;
        padding: 0;
      }
      #controls {
        padding: 10px;
        background: #222;
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }
      #balance,
      #portfolio {
        font-weight: bold;
      }
      canvas {
        display: block;
        background: #111;
        margin: 10px auto;
        max-width: 95%;
      }
      #orderBook,
      #tradeHistory {
        padding: 5px;
        margin: 5px;
        background: #222;
        max-height: 200px;
        overflow: auto;
      }
      #orderBook div {
        display: flex;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      残高: <span id="balance">-</span>
      <select id="symbolSelect"></select>
      <select id="sideSelect">
        <option value="buy">Buy</option>
        <option value="sell">Sell</option>
      </select>
      <input id="priceInput" type="number" placeholder="Price" />
      <input id="amountInput" type="number" value="1" min="1" />
      <select id="typeSelect">
        <option value="limit">指値</option>
        <option value="market">成行</option>
        <option value="stop">逆指値</option>
      </select>
      <input id="stopInput" type="number" placeholder="StopPrice" />
      <button id="placeBtn">注文</button>
      <div id="portfolio"></div>
    </div>

    <div id="orderBook">
      <h4>Order Book</h4>
      <div id="buyOrders"></div>
      <div id="sellOrders"></div>
    </div>

    <div id="tradeHistory">
      <h4>Trade History</h4>
    </div>

    <canvas id="priceChart" height="200"></canvas>

    <script>
      const socket = io();
      let currentUser = { balance: 0, holdings: {}, learningMode: true };
      let companies = [],
        chart = [];

      socket.on("userData", (data) => {
        currentUser = data;
        document.getElementById("balance").textContent =
          data.balance.toFixed(2);
        updatePortfolio();
      });

      socket.on("state", (payload) => {
        companies = payload.companies;
        const sel = document.getElementById("symbolSelect");
        sel.innerHTML = "";
        companies.forEach((c) => sel.add(new Option(c.symbol, c.symbol)));
        updateChart();
        updateOrderBook();
      });

      socket.on("trade", (t) => {
        const hist = document.getElementById("tradeHistory");
        hist.innerHTML =
          `<div>${t.symbol} ${t.amount}株 @ ${t.price}</div>` + hist.innerHTML;
      });

      document.getElementById("placeBtn").addEventListener("click", () => {
        const symbol = document.getElementById("symbolSelect").value;
        const side = document.getElementById("sideSelect").value;
        const price = Number(document.getElementById("priceInput").value);
        const amount = Number(document.getElementById("amountInput").value);
        const type = document.getElementById("typeSelect").value;
        const stopPrice = document.getElementById("stopInput").value || null;
        socket.emit("placeOrder", {
          symbol,
          side,
          price,
          amount,
          type,
          stopPrice,
        });
      });

      function updatePortfolio() {
        const div = document.getElementById("portfolio");
        let html = "";
        for (const sym in currentUser.holdings) {
          html += `${sym}: ${currentUser.holdings[sym]}株<br>`;
        }
        div.innerHTML = html;
      }

      function updateOrderBook() {
        if (!companies.length) return;
        const company = companies[0];
        document.getElementById("buyOrders").innerHTML = company.orderBook.buy
          .map((o) => `${o.price} : ${o.amount}`)
          .join("<br>");
        document.getElementById("sellOrders").innerHTML = company.orderBook.sell
          .map((o) => `${o.price} : ${o.amount}`)
          .join("<br>");
      }

      function updateChart() {
        const ctx = document.getElementById("priceChart").getContext("2d");
        const labels = companies.map((c) => c.symbol);
        const data = companies.map((c) => c.price);
        if (!chart.length) {
          chart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [{ label: "Price", data, backgroundColor: "#0f0" }],
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } },
          });
        } else {
          chart.data.labels = labels;
          chart.data.datasets[0].data = data;
          chart.update();
        }
      }
    </script>
  </body>
</html>
