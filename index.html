<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>架空株式市場</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body {
        font-family: sans-serif;
        background: #121212;
        color: #eee;
        margin: 0;
        padding: 0;
      }
      h2,
      h4 {
        margin: 5px 0;
      }
      #controls {
        padding: 10px;
        background: #222;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        align-items: center;
      }
      #balance,
      #portfolio {
        font-weight: bold;
      }
      canvas {
        display: block;
        background: #111;
        margin: 10px auto;
        max-width: 95%;
      }
      .section {
        padding: 5px;
        margin: 5px;
        background: #222;
      }
      #orderBook div {
        display: flex;
        justify-content: space-between;
      }
      label {
        display: block;
        font-size: 0.8em;
        color: #aaa;
      }
      input,
      select,
      button {
        width: 100%;
        padding: 4px;
        border: none;
        border-radius: 3px;
      }
      button {
        background: #0a0;
        color: #fff;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>架空株式市場</h2>

    <div id="controls">
      <div>
        <label>残高</label>
        <span id="balance">-</span>
      </div>
      <div>
        <label>銘柄選択</label>
        <select id="symbolSelect"></select>
      </div>
      <div>
        <label>売買</label>
        <select id="sideSelect">
          <option value="buy">買い</option>
          <option value="sell">売り</option>
        </select>
      </div>
      <div>
        <label>注文タイプ</label>
        <select id="typeSelect">
          <option value="limit">指値</option>
          <option value="market">成行</option>
          <option value="stop">逆指値</option>
        </select>
      </div>
      <div>
        <label>価格（指値/逆指値）</label>
        <input id="priceInput" type="number" placeholder="Price" />
      </div>
      <div>
        <label>逆指値価格（Stop）</label>
        <input id="stopInput" type="number" placeholder="StopPrice" />
      </div>
      <div>
        <label>株数</label>
        <input id="amountInput" type="number" value="1" min="1" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="placeBtn">注文</button>
      </div>
      <div>
        <label>保有株</label>
        <div id="portfolio"></div>
      </div>
    </div>

    <div class="section" id="orderBook">
      <h4>Order Book</h4>
      <div id="buyOrders"></div>
      <div id="sellOrders"></div>
    </div>

    <div class="section" id="tradeHistory">
      <h4>Trade History</h4>
    </div>

    <canvas id="priceChart" height="200"></canvas>

    <script>
      const socket = io();
      let currentUser = { balance: 0, holdings: {}, learningMode: true };
      let companies = [],
        priceHistory = {},
        chart = null;

      // ページロード時に注文フォームの表示を更新
      document.addEventListener("DOMContentLoaded", () => {
        const typeSelect = document.getElementById("typeSelect");
        const priceInput = document.getElementById("priceInput");
        const stopInput = document.getElementById("stopInput");

        function updateOrderFormVisibility() {
          const selectedType = typeSelect.value;
          if (selectedType === "market") {
            priceInput.disabled = true;
            priceInput.value = ""; // 成行の場合は価格入力をクリア
            stopInput.disabled = true;
            stopInput.value = ""; // ストップ価格入力をクリア
          } else if (selectedType === "limit") {
            priceInput.disabled = false;
            stopInput.disabled = true;
            stopInput.value = "";
          } else if (selectedType === "stop") {
            priceInput.disabled = false; // 逆指値の場合も指値価格を入力させる
            stopInput.disabled = false;
          }
        }

        typeSelect.addEventListener("change", updateOrderFormVisibility);
        // 初期ロード時にも適用
        updateOrderFormVisibility();
      });

      socket.on("userData", (data) => {
        currentUser = data;
        document.getElementById("balance").textContent =
          data.balance.toFixed(2);
        updatePortfolio();
      });

      socket.on("state", (payload) => {
        companies = payload.companies;
        const sel = document.getElementById("symbolSelect");
        // 銘柄リストが空の場合のみ更新
        if (sel.options.length === 0 && companies.length > 0) {
          companies.forEach((c) => sel.add(new Option(c.symbol, c.symbol)));
          // 初回ロード時にチャートと板情報を更新
          updateOrderBook();
          updateChart();
        }

        // 価格履歴
        companies.forEach((c) => {
          if (!priceHistory[c.symbol]) priceHistory[c.symbol] = [];
          priceHistory[c.symbol].push(c.price);
          if (priceHistory[c.symbol].length > 50)
            priceHistory[c.symbol].shift();
        });
        // 選択されている銘柄のチャートと板情報を更新
        updateChart();
        updateOrderBook();
      });

      socket.on("trade", (t) => {
        const hist = document.getElementById("tradeHistory");
        const tradeEntry = document.createElement("div");
        tradeEntry.textContent = `${t.symbol} ${t.amount}株 @ ${t.price.toFixed(
          2
        )}`;
        hist.prepend(tradeEntry); // 新しい取引を一番上に追加
        // 履歴が長くなりすぎたら古いものを削除
        if (hist.children.length > 20) {
          hist.removeChild(hist.lastChild);
        }
      });

      document.getElementById("placeBtn").addEventListener("click", () => {
        const symbol = document.getElementById("symbolSelect").value;
        const side = document.getElementById("sideSelect").value;
        const type = document.getElementById("typeSelect").value;
        let price = null;
        let stopPrice = null;

        if (type !== "market") {
          price = Number(document.getElementById("priceInput").value);
          if (isNaN(price) || price <= 0) {
            alert("有効な価格を入力してください。");
            return;
          }
        }
        if (type === "stop") {
          stopPrice = Number(document.getElementById("stopInput").value);
          if (isNaN(stopPrice) || stopPrice <= 0) {
            alert("有効な逆指値価格を入力してください。");
            return;
          }
        }

        const amount = Number(document.getElementById("amountInput").value);
        if (isNaN(amount) || amount <= 0) {
          alert("有効な株数を入力してください。");
          return;
        }

        socket.emit("placeOrder", {
          symbol,
          side,
          price,
          amount,
          type,
          stopPrice,
        });
      });

      // 銘柄選択が変更されたときに板情報とチャートを更新
      document.getElementById("symbolSelect").addEventListener("change", () => {
        updateOrderBook();
        updateChart();
      });

      function updatePortfolio() {
        const div = document.getElementById("portfolio");
        let html = "";
        for (const sym in currentUser.holdings) {
          if (currentUser.holdings[sym] > 0) {
            // 保有株数が0より大きい場合のみ表示
            html += `${sym}: ${currentUser.holdings[sym]}株<br>`;
          }
        }
        div.innerHTML = html || "保有株なし"; // 保有株がない場合の表示
      }

      function updateOrderBook() {
        const selectedSymbol = document.getElementById("symbolSelect").value;
        const company = companies.find((c) => c.symbol === selectedSymbol);

        if (!company) {
          document.getElementById("buyOrders").innerHTML =
            "<b>買い板</b><br>選択された銘柄のデータがありません";
          document.getElementById("sellOrders").innerHTML =
            "<b>売り板</b><br>選択された銘柄のデータがありません";
          return;
        }

        // サーバーから送られてくる orderBook は既にソートされていると仮定
        document.getElementById("buyOrders").innerHTML =
          "<b>買い板</b><br>" +
          (company.orderBook.buy || [])
            .map(
              (o) =>
                `${o.price.toFixed(2)} : ${o.amount}${
                  o.type === "stop"
                    ? " (Stop:" + o.stopPrice.toFixed(2) + ")"
                    : ""
                }`
            )
            .join("<br>");
        document.getElementById("sellOrders").innerHTML =
          "<b>売り板</b><br>" +
          (company.orderBook.sell || [])
            .map(
              (o) =>
                `${o.price.toFixed(2)} : ${o.amount}${
                  o.type === "stop"
                    ? " (Stop:" + o.stopPrice.toFixed(2) + ")"
                    : ""
                }`
            )
            .join("<br>");
      }

      function updateChart() {
        const ctx = document.getElementById("priceChart").getContext("2d");
        const selectedSymbol = document.getElementById("symbolSelect").value;

        if (!selectedSymbol || !priceHistory[selectedSymbol]) {
          // 選択された銘柄がないか、履歴がない場合はチャートをクリア
          if (chart) {
            chart.destroy();
            chart = null;
          }
          return;
        }

        const data = priceHistory[selectedSymbol];
        // 履歴の長さに応じたラベルを動的に生成
        const labels = data.map((_, i) => i + 1);

        const datasets = [
          {
            label: selectedSymbol,
            data: data,
            borderColor: `hsl(0,80%,50%)`, // 選択された銘柄は固定の色
            backgroundColor: "transparent",
            tension: 0.2,
          },
        ];

        if (!chart) {
          chart = new Chart(ctx, {
            type: "line",
            data: { labels, datasets },
            options: {
              responsive: true,
              animation: false,
              plugins: { legend: { position: "top" } },
              scales: { y: { beginAtZero: false } },
            },
          });
        } else {
          chart.data.datasets = datasets;
          chart.data.labels = labels;
          chart.update();
        }
      }
    </script>
  </body>
</html>
